const qaArray = [
    {
        question: ["Schedule for Garbage Pickup in the Villanueva Area."],
        answer: "PickUp Days: Saturday\nPickUp Time: 6:45 AM - 8:30 AM\n\nNote:\n  * Please ensure that garbage is placed outside by the designated time.\n  * Use approved garbage bins and separate recyclables when possible."
    },
    {
        question: ["Garbage Pickup Schedule for All Villanueva Barangays."],
        answer: "PickUp Days: Monday, Wednesday, Friday\nPickUp Time: 6:45 AM - 8:30 AM"
    },
    {
        question: ["Are there any changes to the pickup schedule for holidays?"],
        answer: "There will be no waste pickups on holidays. Please plan accordingly and\nrefer to the updated schedule for the next available pickup date."
    },
    {
        question: ["What are the fees for garbage collection, and how can I pay?"],
        answer: "The garbage collection fee is 500 PHP, and additional charges may apply from the garbage collector.\n\nYou can pay directly to the garbage collector or through the payment methods they provide."
    },
    {
        question: ["Plumbing Service", "Plumber Service"],
        answer: "Hi, I'm Axion. How can I help you with plumbing services?"
    },
    {
        question: ["Carpentry Service", "Carpenter Service"],
        answer: "Hi, I'm Axion. How can I help you with carpentry services?"
    },
    {
        question: ["Who are you", "Hi", "Hello", "Hey", "Hola", "Hoy", "Axion", "Heey", "Hai", "Hii", "What do you do?", "Axion??", "Axion?"],
        answer: "Hi, I'm Axion. I'm here to help you with your garbage disposal, plumbing, and carpentry needs.\n\nPlease note that while I strive to provide accurate information, there may be occasional inaccuracies.\nI kindly ask that you limit your inquiries to garbage disposal, plumbing, and carpentry-related topics."
    },
    {
        question: ["What is Garbage?", "Is Garbage"],
        answer: "Garbage refers to waste materials or unwanted items that are discarded because they are no longer useful, needed, or functional.\n\nIt typically includes household waste such as food scraps, packaging materials, broken items, and other disposable materials.\n\nGarbage can be categorized into different types, such as:\n  * **Biodegradable Waste**: Organic materials that decompose naturally over time, such as food scraps, garden waste, and paper.\n  * **Non-Biodegradable Waste**: Materials that do not easily break down, such as plastics, metals, and glass.\n  * **Hazardous Waste**: Substances that can be harmful to health or the environment, such as chemicals, batteries, and medical waste.\n  * **E-Waste**: Discarded electronic devices like phones, computers, and appliances."
    },
    {
        question: ["What is Recycle?", "Recycling", "Recycling?", "What is Recycling"],
        answer: "Recycling is the process of collecting, processing, and reusing materials that would otherwise be thrown away as waste.\n\nThe goal of recycling is to convert used or discarded items into new materials or products, reducing the need for raw resources, conserving energy, and minimizing environmental impact.\n\n**Key Steps in Recycling:**\n  1. **Collection**: Waste is collected from homes, businesses, and recycling centers.\n  2. **Sorting**: Materials are separated into categories like paper, plastic, metal, and glass to ensure only recyclable items are processed.\n  3. **Processing**: Recyclable materials are cleaned, broken down, and transformed into raw materials.\n  4. **Manufacturing**: These raw materials are used to create new products, such as recycled paper, aluminum cans, or plastic bottles.\n  5. **Purchasing**: Buying products made from recycled materials completes the cycle and encourages sustainable practices.\n\nRecycling helps reduce landfill waste, conserve natural resources, lower greenhouse gas emissions, and save energy. It supports a circular economy where materials are reused rather than discarded."
    },
    {
        question: ["What can be recycled?", "can recycled", "recycled"],
        answer: "Recyclable materials generally include items that can be processed and transformed into new products.\n\nCommon recyclables are:\n  1. Paper and Cardboard: Office paper, newspapers, magazines, paper bags, cardboard boxes (clean and dry). Avoid recycling paper that is wet, greasy, or heavily soiled.\n  2. Plastics: Many plastics marked with recycling codes #1 (PET) and #2 (HDPE), such as water bottles and detergent containers, are widely accepted. Check local guidelines for other codes (#3â€“#7).\n  3. **Metals**: Aluminum cans, tin cans, steel containers, and clean foil. Avoid items like paint cans unless cleaned and approved.\n  4. **Glass**: Bottles and jars (clear, green, or brown). Avoid ceramics, mirrors, or tempered glass.\n  5. **Electronics**: Old phones, laptops, and batteries can often be recycled at specialized facilities.\n\n**Note**: Always rinse containers to remove food residue and follow your local recycling guidelines to ensure proper sorting and acceptance."
    },
    {
        question: ["Segregation and Recycling", "What can be recycled?", "How do I separate wet and dry waste?", "Which types of plastics are recyclable?", "Can electronic waste go in the regular trash?", "Why should I separate waste?", "What happens if recyclables are mixed with trash?"],
        answer: 
            "**Segregation and Recycling:**\n\n" +
            "1. **What can be recycled?**\n   Items like paper, cardboard, plastics (check local guidelines), metals, and glass can typically be recycled. Avoid contaminated or greasy materials.\n\n" +
            "2. **How do I separate wet and dry waste?**\n   - Wet waste: Organic materials like food scraps and garden waste.\n   - Dry waste: Plastics, metals, paper, and other non-biodegradable items. Keep them clean and dry.\n\n" +
            "3. **Which types of plastics are recyclable?**\n   Plastics marked with codes #1 (PET) and #2 (HDPE) are most commonly recyclable. Other types depend on local facilities.\n\n" +
            "4. **Can electronic waste go in the regular trash?**\n   No, e-waste like old phones, batteries, and appliances should be taken to specialized recycling centers.\n\n" +
            "5. **Why should I separate waste?**\n   Separating waste makes recycling efficient, reduces landfill overflow, and helps protect the environment.\n\n" +
            "6. **What happens if recyclables are mixed with trash?**\n   Mixed waste often ends up in landfills because contaminated recyclables can't be processed."
    },
    {
        question: ["Disposal", "Where should I dispose of hazardous waste?", "How do I properly dispose of food waste?", "Can I throw broken glass in the garbage?", "Is it okay to put batteries in the trash?", "How do I dispose of large items like furniture?", "What should I do with old clothes?"],
        answer: 
            "**Disposal:**\n\n" +
            "1. **Where should I dispose of hazardous waste?**\n   Hazardous materials like chemicals, paints, and batteries should be taken to designated disposal facilities.\n\n" +
            "2. **How do I properly dispose of food waste?**\n   Compost food scraps or place them in a biodegradable waste bin if available.\n\n" +
            "3. **Can I throw broken glass in the garbage?**\n   Wrap broken glass securely in newspaper or a thick bag and label it before disposal to prevent injury.\n\n" +
            "4. **Is it okay to put batteries in the trash?**\n   No, batteries should be disposed of at e-waste or battery recycling facilities.\n\n" +
            "5. **How do I dispose of large items like furniture?**\n   Contact your local waste management service for bulk item pickup or donate usable furniture to charities.\n\n" +
            "6. **What should I do with old clothes?**\n   Donate wearable clothes, recycle unusable ones at textile recycling centers, or repurpose them into household items."
    },
    {
        question: ["Composting", "What items can go in a compost bin?", "How do I start composting at home?", "Can cooked food scraps be composted?", "How long does composting take?", "What are the benefits of composting?"],
        answer: 
            "**Composting:**\n\n" +
            "1. **What items can go in a compost bin?**\n   Fruit peels, vegetable scraps, coffee grounds, tea bags, eggshells, and yard waste are great for composting. Avoid meat, dairy, and oily foods.\n\n" +
            "2. **How do I start composting at home?**\n   Choose a compost bin, add organic waste in layers, maintain a balance of greens (wet waste) and browns (dry waste), and turn it regularly for aeration.\n\n" +
            "3. **Can cooked food scraps be composted?**\n   Some cooked food scraps can be composted, but avoid items with oils, dairy, or meat, as they attract pests.\n\n" +
            "4. **How long does composting take?**\n   Composting can take 2-6 months, depending on the material and how often it is aerated.\n\n" +
            "5. **What are the benefits of composting?**\n   Composting enriches soil, reduces landfill waste, and minimizes methane emissions from organic waste."
    },
    {
        question: ["Environmental Concerns", "What happens to my garbage after collection?", "How does improper waste disposal affect the environment?", "What are the benefits of reducing waste?", "What is the impact of plastic pollution?", "Why is landfill waste harmful?"],
        answer: 
            "**Environmental Concerns:**\n\n" +
            "1. **What happens to my garbage after collection?**\n   Garbage is typically taken to landfills, recycling centers, or waste-to-energy plants, depending on its type and local facilities.\n\n" +
            "2. **How does improper waste disposal affect the environment?**\n   It leads to pollution, harms wildlife, and contributes to climate change through increased greenhouse gas emissions.\n\n" +
            "3. **What are the benefits of reducing waste?**\n   Reducing waste conserves resources, saves energy, reduces pollution, and helps mitigate climate change.\n\n" +
            "4. **What is the impact of plastic pollution?**\n   Plastic pollution harms marine life, contaminates soil and water, and takes hundreds of years to decompose.\n\n" +
            "5. **Why is landfill waste harmful?**\n   Landfills emit methane, a potent greenhouse gas, and can leach toxic substances into soil and groundwater."
    },
    {
        question: ["Local Policies and Regulations", "What are the waste disposal rules in my area?", "When is garbage collection day?", "Are there fines for not segregating waste?", "Who do I contact for bulky waste pickup?", "What are the rules for recycling in my area?"],
        answer: 
            "**Local Policies and Regulations:**\n\n" +
            "1. **What are the waste disposal rules in my area?**\n   Check with your local government or waste management authority for specific guidelines.\n\n" +
            "2. **When is garbage collection day?**\n   Garbage collection schedules vary by area. Refer to your community's waste management calendar.\n\n" +
            "3. **Are there fines for not segregating waste?**\n   Many areas impose fines for improper waste segregation to encourage compliance. Check local regulations.\n\n" +
            "4. **Who do I contact for bulky waste pickup?**\n   Contact your local waste management department or municipality for scheduling bulky waste collection.\n\n" +
            "5. **What are the rules for recycling in my area?**\n   Refer to your local recycling program for guidelines on accepted materials and preparation steps."
    },
    {
        question: ["Tips for Reducing Waste", "How can I reduce plastic usage?", "What are some ways to minimize food waste?", "What are good alternatives to single-use items?", "How can I encourage others to reduce waste?"],
        answer: 
            "**Tips for Reducing Waste:**\n\n" +
            "1. **How can I reduce plastic usage?**\n   Use reusable bags, bottles, and containers. Avoid single-use plastics whenever possible.\n\n" +
            "2. **What are some ways to minimize food waste?**\n   Plan meals, store food properly, and compost scraps.\n\n" +
            "3. **What are good alternatives to single-use items?**\n   Switch to metal straws, cloth napkins, and glass or metal containers.\n\n" +
            "4. **How can I encourage others to reduce waste?**\n   Lead by example, share tips, and participate in community clean-up or waste reduction initiatives."
    },
    {
        question: ["Reusing and Repurposing", "What can I repurpose old clothes into?", "Are there creative ways to reuse glass jars?", "How do I upcycle furniture or household items?", "What are some DIY projects for reusing waste?"],
        answer: 
            "**Reusing and Repurposing:**\n\n" +
            "1. **What can I repurpose old clothes into?**\n   Turn old clothes into cleaning rags, tote bags, or patchwork quilts.\n\n" +
            "2. **Are there creative ways to reuse glass jars?**\n   Use glass jars as storage containers, planters, or candle holders.\n\n" +
            "3. **How do I upcycle furniture or household items?**\n   Repaint or refinish old furniture, or transform them into functional decor pieces.\n\n" +
            "4. **What are some DIY projects for reusing waste?**\n   Create bird feeders from plastic bottles, plant holders from tin cans, or unique art pieces from waste materials."
    },
    {
        question: ["How do I fix a leaking faucet?", "What causes low water pressure?", "How do I unclog a drain?", "What are common causes of pipe leaks?", "How can I prevent frozen pipes?", "When should I call a plumber?", "Why is my toilet constantly running?"],
        answer: 
            "**Plumbing:**\n\n" +
            "1. **How do I fix a leaking faucet?**\n   Turn off the water supply, disassemble the faucet, replace the washer or O-ring, and reassemble it. If unsure, consult a plumber.\n\n" +
            "2. **What causes low water pressure?**\n   Common causes include clogged pipes, a malfunctioning pressure regulator, or issues with the local water supply.\n\n" +
            "3. **How do I unclog a drain?**\n   Use a plunger, drain snake, or a mixture of baking soda and vinegar. Avoid harsh chemical cleaners as they can damage pipes.\n\n" +
            "4. **What are common causes of pipe leaks?**\n   Corrosion, high water pressure, loose connections, or freezing and thawing cycles can lead to leaks.\n\n" +
            "5. **How can I prevent frozen pipes?**\n   Insulate pipes, let faucets drip during freezing weather, and keep the thermostat consistent.\n\n" +
            "6. **When should I call a plumber?**\n   Call a professional for major leaks, burst pipes, water heater issues, or persistent drainage problems.\n\n" +
            "7. **Why is my toilet constantly running?**\n   Check the flapper valve, fill valve, and float. Adjust or replace these components as needed."
    },
    {
        question: ["How do I fix a squeaky door?", "What tools are essential for basic carpentry?", "How can I repair a broken wooden chair?", "What type of wood is best for furniture?", "How do I sand and refinish wood?", "How can I measure and cut wood accurately?", "What is the difference between hardwood and softwood?"],
        answer: 
            "**Carpentry:**\n\n" +
            "1. **How do I fix a squeaky door?**\n   Apply lubricant (like WD-40) to the hinges or tighten loose screws. If needed, replace the hinges.\n\n" +
            "2. **What tools are essential for basic carpentry?**\n   Essential tools include a hammer, screwdriver, tape measure, saw, drill, level, and sandpaper.\n\n" +
            "3. **How can I repair a broken wooden chair?**\n   Disassemble the chair, apply wood glue to the joints, clamp the pieces tightly, and let it dry before reassembling.\n\n" +
            "4. **What type of wood is best for furniture?**\n   Hardwood like oak, maple, or walnut is durable and ideal for furniture, while softwood like pine is budget-friendly but less sturdy.\n\n" +
            "5. **How do I sand and refinish wood?**\n   Sand the surface with progressively finer sandpaper, clean off the dust, apply stain or paint, and finish with a protective sealant.\n\n" +
            "6. **How can I measure and cut wood accurately?**\n   Use a tape measure, square, and pencil to mark the wood. Cut slowly with a saw or power tool, following the guide lines.\n\n" +
            "7. **What is the difference between hardwood and softwood?**\n   Hardwood comes from deciduous trees and is dense and durable, while softwood comes from conifers and is lighter and easier to work with."
    },
    {
        question: ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", 
                   "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z"],
        answer: "Hey, how can I help you?"
    },
];


// Garbage Pickup Addresses
const garbagePickupAddresses = [
    "villanueva", "dayawan", "san martin", "imelda", "poblacion 1", "pob 2",
    "pob 3", "pob 4", "looc", "tambobong", "kimaya", "katipunan", "balacanas"
];

// DOM Elements
const messageForm = document.querySelector(".prompt__form");
const chatHistoryContainer = document.querySelector(".chats");
const themeToggleButton = document.getElementById("themeToggler");
const clearChatButton = document.getElementById("deleteButton");

// State Variables
let currentUserMessage = null;
let isGeneratingResponse = false;

// Mock Secure API Key Fetch (for demonstration)
const fetchApiKey = async () => {
    return "AIzaSyCOb8OTbW2wlWIhC2MQ69surifcQcd0XqA";
};

// Load Saved Chat History
const loadSavedChatHistory = () => {
    const savedConversations = JSON.parse(localStorage.getItem("saved-api-chats")) || [];
    const isLightTheme = localStorage.getItem("themeColor") === "light_mode";

    document.body.classList.toggle("light_mode", isLightTheme);
    themeToggleButton.setAttribute("aria-label", isLightTheme ? "Switch to dark mode" : "Switch to light mode");
    themeToggleButton.innerHTML = isLightTheme ? '<i class="bx bx-moon"></i>' : '<i class="bx bx-sun"></i>';

    chatHistoryContainer.innerHTML = '';

    savedConversations.forEach(({ userMessage, apiResponse }) => {
        addChatMessage(userMessage, "outgoing");
        addChatMessage(apiResponse, "incoming");
    });

    document.body.classList.toggle("hide-header", savedConversations.length > 0);
};

// Add Chat Message
const addChatMessage = (message, type) => {
    const isOutgoing = type === "outgoing";
    const avatar = isOutgoing ? "profile.png" : "robot.png";
    const ariaLabel = isOutgoing ? "User message" : "System response";

    const messageHtml = `
        <div class="message__content" aria-label="${ariaLabel}" role="region">
            <img class="message__avatar" src="assets/${avatar}" alt="${ariaLabel}">
            <p class="message__text">${message}</p>
        </div>
    `;
    const cssClass = isOutgoing ? "message--outgoing" : "message--incoming";
    chatHistoryContainer.appendChild(createChatMessageElement(messageHtml, cssClass));
};

// Create Chat Message Element
const createChatMessageElement = (htmlContent, ...cssClasses) => {
    const messageElement = document.createElement("div");
    messageElement.classList.add("message", ...cssClasses);
    messageElement.innerHTML = htmlContent;
    return messageElement;
};

// Clear Chat History
clearChatButton.addEventListener("click", () => {
    if (isGeneratingResponse || !confirm("Clear all conversation history?")) return;
    chatHistoryContainer.innerHTML = '';
    document.body.classList.remove("hide-header");
    localStorage.removeItem("saved-api-chats");
});

// Display Loading Animation
const displayLoadingAnimation = () => {
    const loadingHtml = `
        <div class="message__content" role="region" aria-label="Processing response">
            <img class="message__avatar" src="assets/robot.png" alt="Loading">
            <p class="message__text">Processing your request...</p>
        </div>
    `;
    const loadingMessageElement = createChatMessageElement(loadingHtml, "message--incoming", "message--loading");
    chatHistoryContainer.appendChild(loadingMessageElement);

    fetchResponse(loadingMessageElement);
};

// Fetch Response
// Updated Fetch Response Function
// Updated Fetch Response Function
const fetchResponse = async (loadingElement) => {
    const messageTextElement = loadingElement.querySelector(".message__text");

    if (!currentUserMessage) return;

    const address = garbagePickupAddresses.find(address =>
        currentUserMessage.toLowerCase().includes(address)
    );

    // Handle Carpenter Request
    if (currentUserMessage.toLowerCase().includes("carpenter") && currentUserMessage.toLowerCase().includes("fix")) {
        if (address) {
            messageTextElement.innerText = `A carpenter is on the way to your area (${address}). Please prepare to coordinate with them for details.`;
        } else {
            messageTextElement.innerText = "Please provide your address to proceed (e.g., Villanueva, Dayawan, San Martin).";
        }
        loadingElement.classList.remove("message--loading");
        isGeneratingResponse = false;
        return;
    }

    // Handle Plumber Request
    if (currentUserMessage.toLowerCase().includes("plumber") && currentUserMessage.toLowerCase().includes("fix")) {
        if (address) {
            messageTextElement.innerText = `A plumber is on the way to your area (${address}). Please prepare to coordinate with them for details.`;
        } else {
            messageTextElement.innerText = "Please provide your address to proceed (e.g., Villanueva, Dayawan, San Martin).";
        }
        loadingElement.classList.remove("message--loading");
        isGeneratingResponse = false;
        return;
    }

    // Handle Garbage Collection Request
    if (currentUserMessage.toLowerCase().includes("garbage collection") || 
        currentUserMessage.toLowerCase().includes("need this garbage to be picked up")) {
        messageTextElement.innerText = address
            ? `Request submitted for garbage collection at ${address}. Be ready to pay the service charge fee of 500.`
            : "Please provide your address to proceed (e.g., Villanueva, Dayawan, San Martin).";
        loadingElement.classList.remove("message--loading");
        isGeneratingResponse = false;
        return;
    }

    // Check Predefined Responses
    const predefinedResponse = qaArray.find(qa =>
        qa.question.some(q => currentUserMessage.toLowerCase().includes(q.toLowerCase()))
    );

    if (predefinedResponse) {
        messageTextElement.innerText = predefinedResponse.answer;
        loadingElement.classList.remove("message--loading");
        isGeneratingResponse = false;
        return;
    }

    try {
        const apiKey = await fetchApiKey();

        const requestBody = {
            prompt: currentUserMessage
        };

        const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateText?key=${apiKey}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            const errorData = await response.json();
            console.error("API Error:", errorData);
            throw new Error(errorData.error?.message || "Unable to process your request.");
        }

        const responseData = await response.json();
        const responseText = responseData?.text || "Sorry, I couldn't process your request.";
        messageTextElement.innerText = responseText;
    } catch (error) {
        console.error("Fetch Error:", error);

        messageTextElement.innerText =
            "We're experiencing issues processing your request. Please try again later.\nThank you for your understanding.";
        loadingElement.classList.add("message--error");
    } finally {
        loadingElement.classList.remove("message--loading");
        isGeneratingResponse = false;
    }
};



// Handle Message Submission
messageForm.addEventListener("submit", (event) => {
    event.preventDefault();

    currentUserMessage = messageForm.querySelector(".prompt__form-input").value.trim();
    if (!currentUserMessage || isGeneratingResponse) return;

    addChatMessage(currentUserMessage, "outgoing");
    messageForm.reset();
    document.body.classList.add("hide-header");

    isGeneratingResponse = true;
    displayLoadingAnimation();
});

// Suggestion Click Event Handler
// Suggestion Click Event Handler
const suggestionItems = document.querySelectorAll(".suggests__item-text");

suggestionItems.forEach(suggestion => {
    suggestion.addEventListener('click', () => {
        // Capture the clicked suggestion's text
        currentUserMessage = suggestion.innerText.trim();
        
        // Clear the input field (if necessary)
        messageForm.querySelector(".prompt__form-input").value = currentUserMessage;

        // Trigger the outgoing message handler
        handleOutgoingMessage();  // Process the outgoing message based on the clicked suggestion
    });
});

// Handle Outgoing Message
const handleOutgoingMessage = () => {
    if (!currentUserMessage || isGeneratingResponse) return;

    // Add the user's message to the chat
    addChatMessage(currentUserMessage, "outgoing");

    // Reset the form (if needed)
    messageForm.reset();

    // Hide the header when a new message is added
    document.body.classList.add("hide-header");

    // Set the flag indicating the response is being generated
    isGeneratingResponse = true;

    // Display the loading animation
    displayLoadingAnimation();
};


// Initialize Chat History on Load
window.addEventListener("load", () => {
    loadSavedChatHistory();
});
